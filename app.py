import streamlit as st
import ffmpeg
import os
from tempfile import NamedTemporaryFile

st.title("üéµüîÑ ‡∏ï‡∏±‡∏ß‡πÅ‡∏õ‡∏•‡∏á‡πÑ‡∏ü‡∏•‡πå‡∏ß‡∏¥‡∏î‡∏µ‡πÇ‡∏≠‡πÅ‡∏•‡∏∞‡πÄ‡∏™‡∏µ‡∏¢‡∏á")

uploaded_file = st.file_uploader("‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏ü‡∏•‡πå‡∏ß‡∏¥‡∏î‡∏µ‡πÇ‡∏≠‡∏´‡∏£‡∏∑‡∏≠‡πÄ‡∏™‡∏µ‡∏¢‡∏á", type=["mp4", "mp3", "mov", "avi", "wav", "mkv"])
output_format = st.selectbox("‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡πÑ‡∏ü‡∏•‡πå‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡πÅ‡∏õ‡∏•‡∏á", ["mp3", "mp4", "wav", "avi", "mov"])

if uploaded_file and output_format:
    with NamedTemporaryFile(delete=False, suffix=os.path.splitext(uploaded_file.name)[1]) as temp_input:
        temp_input.write(uploaded_file.read())
        temp_input_path = temp_input.name

    base_filename = os.path.splitext(uploaded_file.name)[0]
    output_filename = f"{base_filename}_converted.{output_format}"
    output_dir = "converted"
    output_path = os.path.join(output_dir, output_filename)
    os.makedirs(output_dir, exist_ok=True)

    try:
        # ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡πÑ‡∏ü‡∏•‡πå‡∏°‡∏µ‡∏ß‡∏¥‡∏î‡∏µ‡πÇ‡∏≠‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà
        probe = ffmpeg.probe(temp_input_path)
        has_video = any(stream['codec_type'] == 'video' for stream in probe['streams'])

        # ‡∏´‡∏≤‡∏Å‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡πÅ‡∏õ‡∏•‡∏á‡πÄ‡∏õ‡πá‡∏ô‡∏ß‡∏¥‡∏î‡∏µ‡πÇ‡∏≠ ‡πÅ‡∏ï‡πà‡πÑ‡∏ü‡∏•‡πå‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏ß‡∏¥‡∏î‡∏µ‡πÇ‡∏≠
        if output_format in ["mp4", "avi", "mov"] and not has_video:
            # ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏ß‡∏¥‡∏î‡∏µ‡πÇ‡∏≠‡∏à‡∏≤‡∏Å‡∏†‡∏≤‡∏û placeholder (‡πÉ‡∏ä‡πâ‡∏†‡∏≤‡∏û‡∏™‡∏µ‡∏î‡∏≥ 1280x720)
            video = ffmpeg.input('color=c=black:s=1280x720:d=10', f='lavfi')
            audio = ffmpeg.input(temp_input_path)

            if output_format == "mp4":
                ffmpeg.output(video, audio, output_path, vcodec='libx264', acodec='aac', format='mp4').run()
            elif output_format == "avi":
                ffmpeg.output(video, audio, output_path, vcodec='mpeg4', acodec='mp3', format='avi').run()
            elif output_format == "mov":
                ffmpeg.output(video, audio, output_path, vcodec='libx264', acodec='aac', format='mov').run()
        else:
            # ‡∏Å‡∏£‡∏ì‡∏µ‡∏õ‡∏Å‡∏ï‡∏¥: ‡πÅ‡∏õ‡∏•‡∏á‡πÅ‡∏ö‡∏ö‡∏ï‡∏£‡∏á
            stream = ffmpeg.input(temp_input_path)

            if output_format == "mp3":
                stream = ffmpeg.output(stream, output_path, format="mp3", acodec="libmp3lame")
            elif output_format == "mp4":
                stream = ffmpeg.output(stream, output_path, vcodec="libx264", acodec="aac", format="mp4")
            elif output_format == "wav":
                stream = ffmpeg.output(stream, output_path, format="wav")
            elif output_format == "avi":
                stream = ffmpeg.output(stream, output_path, vcodec="mpeg4", acodec="mp3", format="avi")
            elif output_format == "mov":
                stream = ffmpeg.output(stream, output_path, vcodec="libx264", acodec="aac", format="mov")
            stream.run()

        # ‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå
        with open(output_path, "rb") as f:
            st.success("‚úÖ ‡πÅ‡∏õ‡∏•‡∏á‡πÑ‡∏ü‡∏•‡πå‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à! ‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏î‡πâ‡∏î‡πâ‡∏≤‡∏ô‡∏•‡πà‡∏≤‡∏á üëá")
            st.download_button("‚¨á ‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏ü‡∏•‡πå‡∏ó‡∏µ‡πà‡πÅ‡∏õ‡∏•‡∏á‡πÅ‡∏•‡πâ‡∏ß", data=f, file_name=output_filename)

    except ffmpeg.Error as e:
        st.error("‚ùå ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÅ‡∏õ‡∏•‡∏á‡πÑ‡∏ü‡∏•‡πå")
        st.text(e.stderr.decode())
